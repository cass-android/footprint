<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <style>
    .bar1 {
      fill: steelblue;
      opacity: 0.9;
    }

    .bar1:hover {
      fill: brown;
      opacity: 1;
    }

    .bar2 {
      fill: #006633;
      opacity: 0.7;
    }

    .bar2:hover {
      fill: brown;
      opacity: 1;
    }

    div.tooltip { 
    position: absolute;     
    text-align: center;     
    width: 60px;          
    height: 28px;         
    padding: 2px;       
    font: 12px sans-serif;    
    background: lightsteelblue; 
    border: 0px;    
    border-radius: 8px;     
    pointer-events: none;     
}




  </style>
</head>
<body>
<script src="https://d3js.org/d3.v5.min.js"></script>
<div>
  <svg width="1300" height="600"></svg>
</div>

<script>
// set the dimensions for the canvas
var svg = d3.select("svg"),
margin = {
  top: 100,
  right: 0,
  bottom: 50,
  left: 100
},
width = +svg.attr("width") - margin.left - margin.right,
height = +svg.attr("height") - margin.top - margin.bottom,

// set the dimensions or the graph
g = svg.append("g").attr("transform", 
  "translate(" + margin.left + "," + margin.top + ")");


// these variables scale data relative to the svg canvas 
var x = d3.scaleBand()
  .range([0, width])  
  .paddingInner(0.1);

var y0 = d3.scaleLinear()
  .rangeRound([height, 0]);

var y1 = d3.scalePoint()
  .range([height, 0]);

// import data from views.py (in JSON)
var graphData = {{ data.chart_data | safe }}
var ylabelData = {{ data.ylabel_data | safe }}

// define the div for the tooltip
var div = d3.select("body").append("div") 
    .attr("class", "tooltip")       
    .style("opacity", 0);

// create a date formatter (used in tooltip. Dates are parsed in views.py)
var formatter = d3.timeFormat("%B %d");

let now = new Date();

graphData.forEach(function(d) {
    d.odate_world = formatter(new Date(d.odate_world))
});

graphData.forEach(function(d) {
    d.odate_can = formatter(new Date(d.odate_can))
});


// draw the graph
function drawGraph(data) {

  // define the ranges for the axes
  x.domain(graphData.map(function (d) {
      return d.year;
    }));
  y0.domain([0, d3.max(graphData, function (d) {
      return Number(d.od_world) + 17;
    })]); 
  y1.domain(ylabelData.map(function (d) {
    return d.month;
  }));

  // add the x axis
  g.append("g")
      .attr("class", "axis")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x))
    .selectAll("text")
      .attr("y", 0)
      .attr("x", 8)
      .attr("dy", ".35em")
      .attr("transform", "rotate(90)")
      .style("text-anchor", "start")
      .style("font-size", "15px");

  // add the y axis
  g.append("g")
      .call(d3.axisLeft(y1))
    .selectAll("text")
      .style("font-size", "15px")

  // add the chart title
  g.append("text")
      .attr("x", (width / 2))
      .attr("y", 2 - (margin.top / 2))
      .attr("text-anchor", "middle")
      .attr("font-family", "Arial, Helvetica, sans-serif")
      .style("font-size", "30px")
      .text("Overshoot Days Since 1961")

  // add the y axis title
  g.append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 20  - margin.left)
      .attr("x", 0 - (height / 2))
      .attr("dy", "0.8em")
      .attr("font-family", "Arial, Helvetica, sans-serif")
      .style("text-anchor", "middle")
      .style("font-size", "20px")
      .text("Month of Overshoot")


  // add the horizontal line
  g.append("g")
      .append("line")
      .attr("x1", 0)
      .attr("x2", width)
      .attr("y1", y0(365))
      .attr("y2", y0(365))
      .style("stroke", "#2ecc71")
      .style("stroke-width", "1px")

  



  // add the bars - World
  g.selectAll(".bar1")
      .data(data)
      .enter().append("rect")
      .attr("class", "bar1")
      .attr("x", function (d) {return x(d.year); })
      .attr("y", function (d) { return y0(Number(d.od_world)); })
      .attr("width", x.bandwidth())
      .attr("height", function (d) {return height - y0(Number(d.od_world)); })
      .on("mouseover", function(d) {    
          div.transition()    
              .duration(200)    
              .style("opacity", .9);   
          //div.html(d.year + "<br/>"  + d.odate_world)
          div.html(d.year + "<br/>"  + "World Overshoot: "  + "<br/>" + d.odate_world)
              .style("left", (d3.event.pageX) + "px")   
              .style("top", (d3.event.pageY) + "px");  
          })          
      .on("mouseout", function(d) {   
          div.transition()    
              .duration(500)    
              .style("opacity", 0); 
      });

  // add the bars - Canada
  g.selectAll(".bar2")
      .data(data)
      .enter().append("rect")
      .attr("class", "bar2")
      .attr("x", function (d) {
        return x(d.year);
      })
      .attr("y", function (d) {return y0(Number(d.od_can_pc)); })
      .attr("width", x.bandwidth())
      .attr("height", function (d) {return height - y0(Number(d.od_can_pc)); })
      .on("mouseover", function(d) {    
          div.transition()    
              .duration(200)    
              .style("opacity", .9);   
          //div.html(d.year + "<br/>"  + d.odate_world)
          div.html(d.year + "<br/>"  + "Canada's Overshoot: "  + "<br/>"  + d.odate_can)
              .style("left", (d3.event.pageX) + "px")   
              .style("top", (d3.event.pageY) + "px");  
          })          
      .on("mouseout", function(d) {   
          div.transition()    
              .duration(500)    
              .style("opacity", 0); 
      });      

};

drawGraph(graphData);

</script>

</body>

</html>

